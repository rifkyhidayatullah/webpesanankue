<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Penjualan</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f7f7f7}
header{background:#ff8fab;color:#fff;padding:15px;text-align:center;font-size:20px;font-weight:bold}
.container{padding:15px;max-width:1000px;margin:auto}
.card{background:#fff;padding:15px;border-radius:12px;margin-bottom:15px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
button{width:100%;padding:10px;border-radius:8px;border:none;background:#ff8fab;color:#fff;font-weight:bold}
input{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd}
</style>
</head>

<body>

<header>ðŸ“Š Dashboard Penjualan</header>

<div class="container">

<button onclick="location.href='index.html'">â¬… Kembali ke Transaksi</button>

<div class="card">
<h3>Diagram Penjualan per Jenis Kue</h3>
<canvas id="chartJenis"></canvas>
</div>

<div class="card">
<h3>Export Laporan Bulanan (Excel)</h3>
<input type="month" id="bulan">
<button onclick="exportExcel()">Download Excel</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
getFirestore, collection, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
apiKey:"AIzaSyCkzEGvVEv-jF-Qg9qGemIAgRSeqQdcThc",
authDomain:"pesanankue.firebaseapp.com",
projectId:"pesanankue"
});

const db=getFirestore(app);
const colRef=collection(db,"transaksi");
let cache=[], chart;

async function loadData(){
const snap=await getDocs(colRef);
snap.forEach(d=>cache.push(d.data()));
renderChart();
}
loadData();

function renderChart(){
let total={};
cache.forEach(t=>{
t.items.forEach(i=>{
total[i.jenis]=(total[i.jenis]||0)+i.jumlah;
});
});
chart=new Chart(document.getElementById("chartJenis"),{
type:"pie",
data:{
labels:Object.keys(total),
datasets:[{data:Object.values(total)}]
}
});
}

window.exportExcel=()=>{
const bulan=document.getElementById("bulan").value;
let data=[["Nama","Tanggal","Jenis","Jumlah"]];
cache.filter(t=>t.tanggalAntar.startsWith(bulan))
.forEach(t=>{
t.items.forEach(i=>{
data.push([t.nama,t.tanggalAntar,i.jenis,i.jumlah]);
});
});
const ws=XLSX.utils.aoa_to_sheet(data);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Laporan");
XLSX.writeFile(wb,"laporan_"+bulan+".xlsx");
}
</script>

</body>
</html>
