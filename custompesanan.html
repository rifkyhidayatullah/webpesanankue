<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Custom Pesanan</title>

<style>
body{margin:0;font-family:Arial;background:#f4f6f9}
header{background:#6c5ce7;color:#fff;padding:15px;text-align:center;font-size:20px;font-weight:bold}
.container{padding:20px;max-width:1000px;margin:auto}
.card{background:#fff;padding:20px;border-radius:14px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
input,select,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ddd}
button{background:#6c5ce7;color:#fff;border:none;font-weight:bold;cursor:pointer}
button.secondary{background:#555}
button.danger{background:#e74c3c}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:center}
.total-box{background:#f1f2ff;padding:15px;border-radius:10px;margin-top:10px;font-weight:bold}
.badgeLunas{color:#2ecc71;font-weight:bold}
.badgeKurang{color:#e74c3c;font-weight:bold}
</style>
</head>

<body>

<header>âœ¨ Custom Pesanan Kue</header>

<div class="container">

<button class="secondary" onclick="location.href='index.html'">â¬… Kembali</button>

<div class="card">

<label>Nama Pemesan</label>
<input id="nama">

<label>Tanggal Pengantaran</label>
<input type="date" id="tanggalAntar">

<label>Status DP</label>
<select id="statusDP" onchange="toggleDP()">
<option>Belum DP</option>
<option>Sudah DP</option>
</select>

<div id="dpBox" style="display:none;">
<label>Nominal DP</label>
<input type="number" id="nominalDP">
</div>

<hr>

<h3>Item Custom</h3>

<label>Nama Produk</label>
<input id="namaProduk" placeholder="Contoh: Bolu Ketan">

<label>Keterangan / Ukuran</label>
<input id="ukuranProduk" placeholder="Contoh: Loyang Besar">

<label>Harga Satuan</label>
<input type="number" id="hargaProduk">

<label>Jumlah</label>
<input type="number" id="jumlahProduk">

<button onclick="tambahItem()">âž• Tambah ke Keranjang</button>
<button onclick="simpanTransaksi()">ðŸ’¾ Simpan Custom Pesanan</button>

</div>

<div class="card">
<h3>ðŸ›’ Keranjang Custom</h3>
<table>
<thead>
<tr>
<th>Nama</th>
<th>Keterangan</th>
<th>Harga</th>
<th>Jumlah</th>
<th>Total</th>
<th></th>
</tr>
</thead>
<tbody id="keranjang"></tbody>
</table>

<div class="total-box">
Total Pesanan: Rp <span id="grandTotal">0</span>
</div>

</div>

<!-- ================= LIST CUSTOM ================= -->
<div class="card">
<h3>ðŸ“‹ Daftar Custom Pesanan</h3>
<div id="listCustom"></div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
getFirestore, collection, addDoc, getDocs,
deleteDoc, doc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
apiKey:"AIzaSyCkzEGvVEv-jF-Qg9qGemIAgRSeqQdcThc",
authDomain:"pesanankue.firebaseapp.com",
projectId:"pesanankue"
});

const db=getFirestore(app);
const colRef=collection(db,"transaksi");

let items=[];
const el=id=>document.getElementById(id);

window.toggleDP=()=>{
dpBox.style.display=
el("statusDP").value==="Sudah DP"?"block":"none";
};

window.tambahItem=()=>{
if(!el("namaProduk").value||!el("hargaProduk").value||!el("jumlahProduk").value)
return alert("Lengkapi data item");

items.push({
jenis:el("namaProduk").value,
ukuran:el("ukuranProduk").value||"-",
hargaManual:+el("hargaProduk").value,
jumlah:+el("jumlahProduk").value,
custom:true
});

renderKeranjang();

el("namaProduk").value="";
el("ukuranProduk").value="";
el("hargaProduk").value="";
el("jumlahProduk").value="";
};

function renderKeranjang(){
keranjang.innerHTML="";
let total=0;

items.forEach((i,idx)=>{
const subtotal=i.hargaManual*i.jumlah;
total+=subtotal;

keranjang.innerHTML+=`
<tr>
<td>${i.jenis}</td>
<td>${i.ukuran}</td>
<td>Rp ${i.hargaManual.toLocaleString()}</td>
<td>${i.jumlah}</td>
<td>Rp ${subtotal.toLocaleString()}</td>
<td><button class="danger" onclick="hapusItem(${idx})">X</button></td>
</tr>`;
});

grandTotal.innerText=total.toLocaleString();
}

window.hapusItem=i=>{
items.splice(i,1);
renderKeranjang();
};

window.simpanTransaksi=async()=>{
if(!el("nama").value||items.length===0)
return alert("Data belum lengkap");

await addDoc(colRef,{
nama:el("nama").value,
tanggalAntar:el("tanggalAntar").value,
statusDP:el("statusDP").value,
nominalDP: el("statusDP").value==="Sudah DP"
? +el("nominalDP").value||0
: 0,
items,
customOrder:true,
waktu:serverTimestamp()
});

alert("Custom pesanan berhasil disimpan!");
items=[];
renderKeranjang();
loadCustom();
};

async function loadCustom(){
listCustom.innerHTML="";
const snap=await getDocs(colRef);

snap.forEach(d=>{
const t=d.data();
if(!t.customOrder) return;

let total=0;
t.items.forEach(i=>{
total+=i.hargaManual*i.jumlah;
});

const dp=t.nominalDP||0;
const sisa=total-dp;

listCustom.innerHTML+=`
<div class="card">
<b>${t.nama}</b><br>
Antar: ${t.tanggalAntar}<br>
${t.items.map(i=>`
â€¢ ${i.jenis} (${i.ukuran})  
Harga: Rp ${i.hargaManual.toLocaleString()}  
Jumlah: ${i.jumlah}  
Subtotal: Rp ${(i.hargaManual*i.jumlah).toLocaleString()}
`).join("<br>")}
<br><br>
Total: Rp ${total.toLocaleString()}<br>
DP: Rp ${dp.toLocaleString()}<br>
<span class="${sisa>0?'badgeKurang':'badgeLunas'}">
${sisa>0?'Sisa: Rp '+sisa.toLocaleString():'LUNAS'}
</span>
<br><br>
<button class="danger" onclick="hapusCustom('${d.id}')">ðŸ—‘ Hapus</button>
</div>
`;
});
}

window.hapusCustom=async id=>{
if(confirm("Hapus custom pesanan ini?")){
await deleteDoc(doc(db,"transaksi",id));
loadCustom();
}
};

loadCustom();
</script>

</body>
</html>
